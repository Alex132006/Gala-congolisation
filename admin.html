<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Bielleterie</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #1a1a1a;
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #2d2d2d;
            border-radius: 10px;
        }

        h1 {
            color: #ff6b6b;
        }

        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #ff3742;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #ff6b6b;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #ff6b6b;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #ff6b6b;
        }

        .btn-primary:hover {
            background: #ff5252;
        }

        .btn-success {
            background: #4CAF50;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-danger {
            background: #ff4757;
        }

        .btn-danger:hover {
            background: #ff3742;
        }

        .btn-warning {
            background: #ffa502;
        }

        .btn-warning:hover {
            background: #e59400;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 5px;
            color: white;
            margin-bottom: 20px;
        }

        .data-table {
            background: #2d2d2d;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        th {
            background: #3d3d3d;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #3d3d3d;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .notification.error {
            background: #ff4757;
        }

        .notification.warning {
            background: #ffa502;
        }

        .session-info {
            font-size: 0.9em;
            color: #ccc;
            margin-right: 15px;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .backup-section {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .backup-list {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .backup-item {
            padding: 10px;
            background: #3d3d3d;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>

<body>
    <div class="notification" id="notification"></div>

    <div class="admin-container">
        <div class="header">
            <h1>üìä Administration Bielleterie</h1>
            <div>
                <span class="session-info" id="sessionInfo">Session active</span>
                <span id="lastUpdate">Chargement...</span>
                <button class="logout-btn" onclick="logout()">üö™ D√©connexion</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalClients">0</div>
                <div>Total Clients</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayClients">0</div>
                <div>Aujourd'hui</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="coupleCount">0</div>
                <div>Couples</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uniteCount">0</div>
                <div>Single</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenue">0</div>
                <div>Revenue (FCFA)</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="exportToExcel()">üì• Export Excel</button>
            <button class="btn btn-success" onclick="loadDashboard()">üîÑ Actualiser</button>
            <button class="btn btn-warning" onclick="showBackupManager()">üíæ Sauvegardes</button>
            <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Tout Supprimer</button>
        </div>

        <div class="export-options">
            <button class="btn btn-primary" onclick="exportToCSV()">üìä Export CSV</button>
            <button class="btn btn-primary" onclick="exportToJSON()">üìã Export JSON</button>
            <button class="btn btn-warning" onclick="showStatistics()">üìà Statistiques</button>
        </div>

        <input type="text" class="search-input" id="searchInput" placeholder="üîç Rechercher un client...">

        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Nom 1</th>
                        <th>Nom 2</th>
                        <th>Email</th>
                        <th>T√©l√©phone</th>
                        <th>Type</th>
                        <th>Paiement</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clientsTable">
                    <tr>
                        <td colspan="8" class="no-data">Chargement des donn√©es...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="backup-section" id="backupSection" style="display: none;">
            <h3>üíæ Gestion des Sauvegardes</h3>
            <div class="controls">
                <button class="btn btn-success" onclick="createBackup()">‚ûï Nouvelle Sauvegarde</button>
                <button class="btn btn-primary" onclick="loadBackups()">üîÑ Actualiser</button>
            </div>
            <div class="backup-list" id="backupList">
                <!-- Liste des sauvegardes -->
            </div>
        </div>
    </div>

    <script>
        // V√âRIFICATION DE S√âCURIT√â RENFORC√âE
        function checkAdminAuth() {
            const isAuthenticated = localStorage.getItem('adminAuthenticated');
            const loginTime = parseInt(localStorage.getItem('adminLoginTime'));
            const sessionDuration = 2 * 60 * 60 * 1000; // 2 heures

            if (!isAuthenticated || isAuthenticated !== 'true' || !loginTime) {
                logout();
                return false;
            }

            // V√©rifier l'expiration de la session
            if (Date.now() - loginTime > sessionDuration) {
                logout();
                showNotification('Session expir√©e. Veuillez vous reconnecter.', 'error');
                return false;
            }

            // Mettre √† jour le temps de session
            document.getElementById('sessionInfo').textContent =
                'Session: ' + Math.floor((sessionDuration - (Date.now() - loginTime)) / 60000) + 'min';

            return true;
        }

        // V√©rifier l'authentification au chargement
        if (!checkAdminAuth()) {
            window.location.href = 'login.html';
        }

        // SYSTEME DE STOCKAGE S√âCURIS√â
        class SecureAdminStorage {
            constructor() {
                this.storageKey = 'bielleterie_clients_secure';
                this.backupKey = 'bielleterie_backup_';
            }

            encrypt(data) {
                try {
                    return btoa(unescape(encodeURIComponent(JSON.stringify(data))));
                } catch (e) {
                    console.error('Erreur de chiffrement:', e);
                    return null;
                }
            }

            decrypt(encryptedData) {
                try {
                    return JSON.parse(decodeURIComponent(escape(atob(encryptedData))));
                } catch (e) {
                    console.error('Erreur de d√©chiffrement:', e);
                    return null;
                }
            }

            saveClients(clients) {
                try {
                    const encryptedData = this.encrypt(clients);
                    if (encryptedData) {
                        localStorage.setItem(this.storageKey, encryptedData);
                        return true;
                    }
                } catch (error) {
                    console.error('Erreur sauvegarde:', error);
                    this.showAdminError('Erreur de sauvegarde des donn√©es');
                }
                return false;
            }

            getClients() {
                try {
                    const encryptedData = localStorage.getItem(this.storageKey);
                    if (encryptedData) {
                        return this.decrypt(encryptedData) || [];
                    }
                } catch (error) {
                    console.error('Erreur r√©cup√©ration:', error);
                }
                return [];
            }

            createBackup() {
                try {
                    const clients = this.getClients();
                    const backup = {
                        data: clients,
                        timestamp: new Date().toISOString(),
                        count: clients.length,
                        id: 'backup_' + Date.now()
                    };

                    const backupKey = this.backupKey + backup.id;
                    localStorage.setItem(backupKey, JSON.stringify(backup));

                    this.cleanOldBackups();
                    return backup;
                } catch (error) {
                    console.error('Erreur backup:', error);
                    return null;
                }
            }

            getBackups() {
                try {
                    const backups = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith(this.backupKey)) {
                            const backup = JSON.parse(localStorage.getItem(key));
                            backups.push(backup);
                        }
                    }
                    return backups.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                } catch (error) {
                    console.error('Erreur r√©cup√©ration backups:', error);
                    return [];
                }
            }

            restoreBackup(backupId) {
                try {
                    const backupKey = this.backupKey + backupId;
                    const backup = JSON.parse(localStorage.getItem(backupKey));
                    if (backup && backup.data) {
                        return this.saveClients(backup.data);
                    }
                } catch (error) {
                    console.error('Erreur restauration:', error);
                }
                return false;
            }

            deleteBackup(backupId) {
                try {
                    const backupKey = this.backupKey + backupId;
                    localStorage.removeItem(backupKey);
                    return true;
                } catch (error) {
                    console.error('Erreur suppression backup:', error);
                    return false;
                }
            }

            cleanOldBackups() {
                try {
                    const backups = this.getBackups();
                    if (backups.length > 10) { // Garder seulement 10 sauvegardes
                        backups.slice(10).forEach(backup => {
                            this.deleteBackup(backup.id);
                        });
                    }
                } catch (error) {
                    console.error('Erreur nettoyage backups:', error);
                }
            }

            showAdminError(message) {
                showNotification(message, 'error');
            }

            showAdminSuccess(message) {
                showNotification(message, 'success');
            }
        }

        // Initialisation du stockage s√©curis√©
        const secureStorage = new SecureAdminStorage();

        // FONCTIONS PRINCIPALES
        function loadDashboard() {
            if (!checkAdminAuth()) return;

            try {
                const clients = secureStorage.getClients();
                updateStats(clients);
                populateTable(clients);
                document.getElementById('lastUpdate').textContent =
                    'Derni√®re mise √† jour: ' + new Date().toLocaleString();

                showNotification('Donn√©es actualis√©es', 'success');
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                showNotification('Erreur de chargement des donn√©es', 'error');
            }
        }

        function updateStats(clients) {
            const today = new Date().toDateString();
            const todayClients = clients.filter(client =>
                new Date(client.timestamp).toDateString() === today
            );

            const coupleCount = clients.filter(client => client.type === 'couple').length;
            const uniteCount = clients.filter(client => client.type === 'unite').length;

            // Calcul du revenue
            const revenue = clients.reduce((total, client) => {
                return total + (client.type === 'couple' ? 5000 : 3000);
            }, 0);

            document.getElementById('totalClients').textContent = clients.length;
            document.getElementById('todayClients').textContent = todayClients.length;
            document.getElementById('coupleCount').textContent = coupleCount;
            document.getElementById('uniteCount').textContent = uniteCount;
            document.getElementById('totalRevenue').textContent = revenue.toLocaleString();
        }

        function populateTable(clients) {
            const tbody = document.getElementById('clientsTable');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">Aucune donn√©e client</td></tr>';
                return;
            }

            const filteredClients = clients.filter(client =>
                client.nom1.toLowerCase().includes(searchTerm) ||
                (client.nom2 && client.nom2.toLowerCase().includes(searchTerm)) ||
                client.email.toLowerCase().includes(searchTerm) ||
                client.phone.includes(searchTerm)
            );

            if (filteredClients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">Aucun r√©sultat trouv√©</td></tr>';
                return;
            }

            tbody.innerHTML = filteredClients.map(client => `
                <tr>
                    <td>${new Date(client.timestamp).toLocaleDateString()}</td>
                    <td>${escapeHtml(client.nom1)}</td>
                    <td>${client.nom2 ? escapeHtml(client.nom2) : '-'}</td>
                    <td>${escapeHtml(client.email)}</td>
                    <td>${escapeHtml(client.phone)}</td>
                    <td><span class="badge">${client.type === 'couple' ? 'Couple' : 'Unit√©'}</span></td>
                    <td>${client.paiement || 'En attente'}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editClient('${client.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteClient('${client.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function exportToCSV() {
            if (!checkAdminAuth()) return;

            try {
                const clients = secureStorage.getClients();
                if (clients.length === 0) {
                    showNotification('Aucune donn√©e √† exporter', 'error');
                    return;
                }

                let csv = 'Date,Nom 1,Nom 2,Email,T√©l√©phone,Type,Paiement,ID\n';

                clients.forEach(client => {
                    const row = [
                        new Date(client.timestamp).toLocaleDateString(),
                        client.nom1,
                        client.nom2 || '',
                        client.email,
                        client.phone,
                        client.type,
                        client.paiement || 'En attente',
                        client.id
                    ].map(field => `"${field}"`).join(',');

                    csv += row + '\n';
                });

                downloadFile(csv, 'bielleterie_clients.csv', 'text/csv');
                showNotification('Export CSV r√©ussi', 'success');
            } catch (error) {
                console.error('Erreur export CSV:', error);
                showNotification('Erreur lors de l\'export CSV', 'error');
            }
        }

        function exportToJSON() {
            if (!checkAdminAuth()) return;

            try {
                const clients = secureStorage.getClients();
                if (clients.length === 0) {
                    showNotification('Aucune donn√©e √† exporter', 'error');
                    return;
                }

                const data = {
                    exportDate: new Date().toISOString(),
                    totalClients: clients.length,
                    clients: clients
                };

                downloadFile(JSON.stringify(data, null, 2), 'bielleterie_clients.json', 'application/json');
                showNotification('Export JSON r√©ussi', 'success');
            } catch (error) {
                console.error('Erreur export JSON:', error);
                showNotification('Erreur lors de l\'export JSON', 'error');
            }
        }

        function exportToExcel() {
            exportToCSV(); // Utilise CSV pour l'instant
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (!checkAdminAuth()) return;

            if (confirm('‚ö†Ô∏è √äTES-VOUS ABSOLUMENT S√õR DE VOULOIR SUPPRIMER TOUTES LES DONN√âES ?\n\nCette action est IRREVERSIBLE et supprimera tous les clients enregistr√©s.')) {
                if (confirm('‚ùå CONFIRMATION FINALE : Cette action ne peut pas √™tre annul√©e. Supprimer toutes les donn√©es ?')) {
                    try {
                        localStorage.removeItem('bielleterie_clients_secure');
                        showNotification('Toutes les donn√©es ont √©t√© supprim√©es', 'success');
                        loadDashboard();
                    } catch (error) {
                        console.error('Erreur suppression:', error);
                        showNotification('Erreur lors de la suppression', 'error');
                    }
                }
            }
        }

        function deleteClient(clientId) {
            if (!checkAdminAuth()) return;

            if (confirm('Supprimer ce client ?')) {
                try {
                    const clients = secureStorage.getClients();
                    const updatedClients = clients.filter(client => client.id !== clientId);

                    if (secureStorage.saveClients(updatedClients)) {
                        showNotification('Client supprim√©', 'success');
                        loadDashboard();
                    }
                } catch (error) {
                    console.error('Erreur suppression client:', error);
                    showNotification('Erreur lors de la suppression', 'error');
                }
            }
        }

        function editClient(clientId) {
            showNotification('Fonction d\'√©dition √† impl√©menter', 'warning');
        }

        function showBackupManager() {
            const section = document.getElementById('backupSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            if (section.style.display === 'block') {
                loadBackups();
            }
        }

        function createBackup() {
            if (!checkAdminAuth()) return;

            const backup = secureStorage.createBackup();
            if (backup) {
                showNotification(`Sauvegarde cr√©√©e (${backup.count} clients)`, 'success');
                loadBackups();
            } else {
                showNotification('Erreur lors de la cr√©ation de la sauvegarde', 'error');
            }
        }

        function loadBackups() {
            if (!checkAdminAuth()) return;

            const backups = secureStorage.getBackups();
            const backupList = document.getElementById('backupList');

            if (backups.length === 0) {
                backupList.innerHTML = '<div class="no-data">Aucune sauvegarde</div>';
                return;
            }

            backupList.innerHTML = backups.map(backup => `
                <div class="backup-item">
                    <div>
                        <strong>${new Date(backup.timestamp).toLocaleString()}</strong>
                        <br><small>${backup.count} clients</small>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="restoreBackup('${backup.id}')">üîÑ Restaurer</button>
                        <button class="btn btn-danger" onclick="deleteBackup('${backup.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function restoreBackup(backupId) {
            if (!checkAdminAuth()) return;

            if (confirm('Restaurer cette sauvegarde ? Les donn√©es actuelles seront remplac√©es.')) {
                if (secureStorage.restoreBackup(backupId)) {
                    showNotification('Sauvegarde restaur√©e', 'success');
                    loadDashboard();
                    loadBackups();
                } else {
                    showNotification('Erreur lors de la restauration', 'error');
                }
            }
        }

        function deleteBackup(backupId) {
            if (!checkAdminAuth()) return;

            if (confirm('Supprimer cette sauvegarde ?')) {
                if (secureStorage.deleteBackup(backupId)) {
                    showNotification('Sauvegarde supprim√©e', 'success');
                    loadBackups();
                } else {
                    showNotification('Erreur lors de la suppression', 'error');
                }
            }
        }

        function showStatistics() {
            const clients = secureStorage.getClients();
            if (clients.length === 0) {
                showNotification('Aucune donn√©e pour les statistiques', 'warning');
                return;
            }

            const stats = {
                total: clients.length,
                couples: clients.filter(c => c.type === 'couple').length,
                unites: clients.filter(c => c.type === 'unite').length,
                revenue: clients.reduce((sum, c) => sum + (c.type === 'couple' ? 5000 : 3000), 0)
            };

            alert(`üìä STATISTIQUES D√âTAILL√âES:
            
Total Clients: ${stats.total}
Couples: ${stats.couples}
Single: ${stats.unites}
Revenue Total: ${stats.revenue.toLocaleString()} FCFA
Moyenne par client: ${Math.round(stats.revenue / stats.total).toLocaleString()} FCFA`);
        }

        function logout() {
            localStorage.removeItem('adminAuthenticated');
            localStorage.removeItem('adminLoginTime');
            localStorage.removeItem('adminSessionId');
            window.location.href = 'login.html';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Recherche en temps r√©el
        document.getElementById('searchInput').addEventListener('input', loadDashboard);

        // Protection contre la navigation accidentelle
        window.addEventListener('beforeunload', (e) => {
            if (localStorage.getItem('adminAuthenticated') === 'true') {
                // Ne pas afficher d'alerte pour une meilleure UX
            }
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            loadDashboard();

            // V√©rifier l'authentification toutes les 30 secondes
            setInterval(checkAdminAuth, 30000);

            // Mettre √† jour le timer de session toutes les minutes
            setInterval(() => {
                if (localStorage.getItem('adminAuthenticated') === 'true') {
                    checkAdminAuth();
                }
            }, 60000);
        });

        // S√©curit√© suppl√©mentaire
        document.addEventListener('keydown', function (e) {
            if (e.key === 'F12') {
                e.preventDefault();
                showNotification('Inspection du code d√©sactiv√©e', 'warning');
            }
        });
    </script>
</body>

</html>